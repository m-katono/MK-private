<!DOCTYPE html>
<html lang="ja" dir="ltr">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
<!--スタイルシートを読み込み-->
<link rel="stylesheet" href="./css/master.css" type="text/css">
        <title>MK-private</title>
    </head>
    <body>
        <div class="top" id="top">
            <h1><a href="https://shangyuanyezhengju.wixsite.com/mkpage" target="_blank" rel="noopener"><img src="./photo/icon.jpg" alt="" width="80px" height="80px"></a><a href="https://m-katono.mydns.jp">MK-private</a></h1>
            <div class="menu"><h2>Page 3</h2>
                Page-<a href="./index.html#menu" class="pagenum">menu</a>-<a href="./first-page.html" class="pagenum">1</a>-<a href="./second-page.html" class="pagenum">2</a>-3-<a href="./fourth-page.html">4</a>-
                <p>
                    新しく出たRaspberry pi 4 Model B のRAM 4GBモデルが欲しい
                </p>
            </div>
<!--MySQLを触って見る準備-->
		<div class="menu" id="i11">
			<h3>MySQLを触ってみる準備（の代わりにMariaDB）</h3>02/Feb/2020
			<p>
			　今のところはDB（データベース）が必要な用事は無いのだが、Web関連の学習をするにあたってDBも使って見るべきだと思った。今までに触ったことがあるのは「やさしいJava　活用編」に出てきたDerbyと、Androidアプリを作った際に使用したSQLiteだけだった。どちらもザックリと触ってみただけなので、完全初心者だ。SQL文についての知識はほぼ０なので、ここは一番メジャーなMySQLを使ってみたいと思う。とはいえ、どんなデータを保存したいか決めなければ使いようがないので、とりあえずインストールだけすることにした。
			<pre class="coding-env"><code>
$sudo apt install mysql-server
			</code></pre>
			　あとは標準の文字コードをUTF-8に変更するくらいの事はしておいた方がいいらしいので、設定ファイルを編集しておくだけ。
			と思ったが、「パッケージが見つからない」的なエラーになった。ネットで調べたら<a href="https://www.codeflow.site/ja/article/how-to-install-the-latest-mysql-on-debian-10" target="_blank">このへん</a>に書いてあったが、どうやら.debのパッケージをダウンロードしてインストールするしか無いみたい。でも代わりにMariaDBというのが推奨されているらしいので、そちらをインストールする。
			<pre class="coding-env"><code>
$sudo apt install mariadb-server
			</code></pre>
			これでインストールできたが、思ったより迷ってしまった。その後の設定方法は<a href="https://www.codeflow.site/ja/article/how-to-install-mariadb-on-debian-10" target="_blank">ここ</a>に書いてある。ちょっとめんどくさいけどオススメ通りにやっておくのが安全そう。
			</p>
			<a href="./index.html#menu" class="button">目次へ戻る</a><br>
			<a href="#top" class="button">先頭へ</a>
		</div>
<!--独自エラーページを作る-->
        <div class="menu" id="i12">
            <h3>独自のエラーページを作る</h3>03/Feb/2020
            <p>
                　Apache標準の簡素なエラ〜ページから独自のページに変更する記事がネット上にたくさん出ているので真似してみた。とはいえそんなに凝るつもりはないので、メインページのデザインを踏襲した感じで言葉だけ変えた。ディレクトリ構造は「サイトのルート/error/ファイル名.html」とした。
            </p>
            <p>
                　他のサイトにも書いてある通り、独自エラーページを作るにはエラーの種類に相当するページを作っておいて、.htaccessファイルに設定を記述する。
                <blockquote>
                    .htaccessの記述<br>
                    〜省略〜<br>
                    ・<br>
                    ・<br>
                    ErrorDocument 401 /error/ファイル名.html<br>
                    ErrorDocument 403 /error/ファイル名.html<br>
                    ErrorDocument 404 /error/ファイル名.html<br>
                    ErrorDocument 500 /error/ファイル名.html<br>
                </blockquote>
                こんな感じで、作成したエラーページまでのパスを指定する。相対パスでも絶対パス（URL）でもいいらしい。あと、.htaccessの使用が有効になっていない場合は有効にする。（ディレクトリの設定を変える）
                <blockquote>
                    /etc/apach2/apache2.conf内<br>
                    〜省略〜<br>
                    ・<br>
                    ・<br>
		    &lt;Directory "/PATH/TO/Website/"><br>
                        Option FollowSymLinks<br>
                        AllowOverride All          #ここをNoneからAllにする<br>
                        Require all granted<br>
		    &lt;/Directory>
                </blockquote>
                　これで動くと思うが、500 Internal Server Errorになる場合にはApache2のrewriteモジュールが無効になっているかもしれないので、調べて有効にする。
            <pre class="coding-env"><code>
$sudo a2enmod rewrite
$sudo systemctl restart apache2
            </code></pre>
                　サイトの中の存在しないページを表示させてみて、自分で作ったエラーページが表示されれば成功。<br>
                https://m-katono.mydns.jp/aaa.htmlにアクセスしてみる。<br>
                <img src="./photo/error-photo.png" alt="error photo" width="600px" oncontextmenu="return false;">
            </p>
            <a href="./index.html#menu" class="button">目次へ戻る</a><br>
            <a href="#top" class="button">先頭へ</a>
        </div>
<!--MacBookAirの冷却ファンについて-->
        <div class="menu" id="i13">
            <h3>MacBook Airの冷却ファンについて</h3>04/Feb/2020
            <p>
                　MacBook Airを使い始めてから２週間がたった。某オークションの商品説明では「ファンが高速で回り続ける」とあったが、確かに高速で回り続けている。ファンがうるさい間は動作がモッサリしていて、古いパソコンを使っているような感覚。よくある「SMCリセット」をしても改善されない。
            </p>
            <p>
                 ただ、数時間の間使用し続けているとファンが静かになってくる時がある。そうなると急にサクサク動き出して、「これが本来のMacBookAirか〜」と思えるような動作になる。
            </p>
            <p>
                 ファンが高速回転している間は「kernel_task」というのが活発に動いていて、CPUの温度管理などもしているらしいが、とても動作が重くなる。アクティビティーモニタで確認すると、kernel_taskのCPU使用率はいつも200%以上になっている。サクサク動いているときには「kernel_task」はあまり動いていない。ここをどうにかすればいつでも快適にMacを使えるのに、対策方法は見つかっていない。
            </p>
            <p>
                <mark>＊　05/Feb/2020　解決記事を追記</mark><br>
                　MacBookのkernel_taskが暴走する事例はかなり多いらしく、たくさんの記事がネット上に見られた。原因は様々だがハードウェアのトラブルに見舞われる人も多く、バッテリー交換やトラックパッド交換で解決する人もいるようだ。自分なりの解決方法を探していくつか試してみた。
                <ol>
                    <li>OSクリーンインストール</li>
                    <li>SMCリセット</li>
                    <li>NVRAMリセット</li>
                    <li>セーフモードで起動</li>
                </ol>
                　OSのクリーンインストールは、手に入れてからすぐに行っていた。改めて実施したのはSMCリセット以降になる。どの操作もまずは電源を切ってから行う。モデルによって操作が異なるようだが、MacBookAir(11inch,Mid2013)の場合には以下かの操作を行う。
                <blockquote>
                    SMCリセット：control+shift+option+電源を10秒以上長押ししてから離し、その後電源を入れる。<br>
                    NVRAMリセット：電源を入れたらすぐにcommand+option+P+Rを押し続け、２度目の起動音がなったら離す。<br>
                    セーフモード：shiftを押しながら電源を入れ、起動したら離す。<br>
                </blockquote>
                　正直なところハードウェアに何らかのトラブルが出ていることを覚悟していた。古いし。でも、セーフモードで起動したら問題が出現せず、再起動したらkernel_taskは正常に戻っていた。めでたし、めでたし。
                <img src="./photo/activity_monitor.png" alt="activity monitor" width="600px" oncontextmenu="return false;">
            </p>
            <p>
                <mark>＊06/Feb/2020 追記</mark><br>
                　その後、場合によってはまたkernel_taskが暴走することがあった。起動直後だし真冬なので実際にCPU温度が高い事はありえない。原因究明のためにCPU温度を監視できる環境を準備した。　
            <pre class="coding-env"><code>
$sudo gem install iStats -n /usr/local/debian
$istats all
            </code></pre>
                istatsを使うと各部の温度センサの値やファンの回転速度をターミナルからコマンドで表示できる。早速確認したところ、kernel_taskがおかしいときにはCPU温度がずっと<strong>-128.0°C</strong>であることが分かった。セーフモードで起動してもそのまま-128.0°Cのときもあれば、平常の温度に戻るときもある。<br>
                マザーボード上の温度センサの不具合か温度を読み取るソフト側の不具合だが、どちらにしろ結構厄介な気がする。
            </p>
            <a href="./index.html#menu" class="button">目次へ戻る</a><br>
            <a href="#top" class="button">先頭へ</a>
        </div>
<!--送信フォームを作る-->
        <div class="menu" id="i14">
            <h3>送信フォームを作る</h3>06/Feb/2020
            <p>
                　このサイトは誰に見せるために作ったわけでもないが、誰がみているか分からない。サイトに問題がある場合に備えて連絡をもらう手段を用意しておかなければならないので最初はメールアドレスを書いておいた。でも、世の中にはどんな悪い奴がいるか分からないのでメールアドレスを晒しておくのはちょっと嫌な気もする。
            </p>
            <p>
                　メルアドを晒さない定番の方法は送信フォームを作ることらしい。それならば送信フォームを作ろうということで、早速作り方を調べてみた。だいたいお決まりの３パターンがあるらしい。
                <ol>
                    <h4>送信フォームの３パターン</h4>
                    <li>htmlのformから入力を受け付け、cgiを使ってsendmailで送信する。</li>
                    <li>htmlのformから入力を受け付けて、ファイルに保存しておく。</li>
                    <li>htmlのformから入力を受け付け、sendmail以外の方法で送信する。</li>
                </ol>
                １番が定番みたいだが、ラズパイには標準でsendmailがインストールされていないので今回はやめておく。２番は保存したファイルを定期的に確認しなきゃならないのでめんどくさい。消去法で３番に決まった。
            </p>
            <p>
                　ちょうどpythonでcgiの勉強中なので、smtplibを使ってpythonで作ることにした。アクセスカウンターの時よりはやや複雑だが、そんなに難しくはないので詳細は他のサイトを参考にして欲しい。流れとしては、<br>
                <blockquote>
                件名、宛先アドレス、送信者アドレス、cc、bcc、本文で送信データを作る。<br>
                ↓<br>
                ユーザーID、パスワード、送信データを送信する。</blockquote>
                こんな流れで送信できた。
            </p>
            <p>
                　ただ、cgiのコードの中にログインIDが書いてあるのはいただけない。cgiのファイル自体は外から見えないところにおいてあるが、万一サーバーの設定を間違うとソースコードがそのまま表示される恐れがある。念のためパスワードは別ファイルから読み込むことにしたが、そこでちょっとハマった。プログラムが最後まで動かずに「Internal Server Error」になってしまったが、結論から言うとテキストファイルの<strong>改行コード</strong>を取り除くのを忘れていた。
            <pre class="coding-env"><code>
# ファイルから読み込む部分
file_path = "相対パス/ファイル"
with open(file_path, 'r') as f:
    # strip()で空白や改行コードを取り除ける
    password = f.readline().strip()
            </code></pre>
                　夜中に布団に入ったままスマホでコーディングしていたせいか、改行コードに気づくのにかなり時間がかかってしまった。プログラミングはパソコンでやったほうがいい。
            </p>
            <a href="./index.html#menu" class="button">目次へ戻る</a><br>
            <a href="#top" class="button">先頭へ</a>
        </div>
<!--Apache2.4の設定ファイルについて-->
        <div class="menu" id="i15">
            <h3>Apache2.4の設定ファイルについて</h3>07/Feb/Feb2020
            <p>
                　独自のエラーページを表示させたり、httpへのアクセスをhttpsにリダイレクトしたりするのに<strong>.htaccess</strong>ファイルを使用していたが、ディレクトリ階層が深くなるにつれてパフォーマンスが落ちてくるというのを知ったので、「.conf」ファイルに全て書くように変更しようと思った。ネット上にたくさんの解説サイトがあるが圧倒的にCentOS上で説明している記事が多く、CentOSだと<strong>httpd.conf</strong>にほとんどの設定を書けば良いらしく、追加するコードの一部を解説している人がほとんど。Debian系のOSにaptでインストールした場合は<strong>apache2.conf</strong>というファイルがその代わりになるので、サンプルコードを真似してそのまま書いてみた。
            </p>
            <p>
                　何も心配していなかったが、いざapacheを再起動しようとしたところエラーになった。書き方を間違ったかと思っていろいろ書き直してみたがなかなかうまくいかない。Apacheのファイルがあるディレクトリを眺めていると、「.conf」の設定ファイルがたくさんあることに気づいた。たぶん環境によって異なると思うが、raspbianの場合はそれぞれの設定ファイルに分けて書かなければならないらしい。
            </p>
            <p>
                　まずは<strong>apache2.conf</strong>ファイルで「.htaccess」を無効にする。
                <blockquote>
                    &lt;Directory "/var/www/html"><br>
                        Options Indexes FollowSymLinks<br>
                        AllowOverride None&nbsp;&nbsp;&nbsp;&nbsp;#ここがNoneだと.htaccess無効<br>
                        Order allow,deny<br>
                        Allow from all<br>
                    &lt;/Directory><br>
                </blockquote>
                httpからhttpsへのリダイレクトはポート80の設定のところに書くので、「/etc/apache2/siteｓ-available/000-default.conf」に書く。
                <blockquote>
                    ・<br>
                    ・<br>
                    〜省略〜<br>
                    RewriteEngine on<br>
                    LogLevel alert rewrite:trace3<br>
                    RewriteCond %{HTTPS} off<br>
                    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R,L]<br>
                    〜省略〜<br>
                    ・<br>
                    ・<br>
                </blockquote>
                独自エラーページについては「/etc/apache2/conf-available/localized-error-pages.conf」に詳しく説明が書いてあるので、それを読みながら設定していく。すでに表示するhtmlファイルを作ってあったので、そのパスを指定する設定だけ書いておいた。
                <blockquote>
                    ErrorDocument 403 /error/作ったページ.html<br>
                    ・<br>
                    ・<br>
                    # 作った分だけ書く<br>
                </blockquote>
                こんな感じでApacheを再起動したらちゃんと動いた！
                <pre class="coding-env"><code>
$sudo systemctl restart apache2
                </code></pre>
            </p>
            <a href="./index.html#menu" class="button">目次へ戻る</a><br>
            <a href="#top" class="button">先頭へ</a>
<!--ここがdivの最後-->
        </div>
    </body>
</html>
